<!-- âœ… PART 1 / 6 â€” index.html (start + <head> + CSS base) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Wheel Forge</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#121a28;
      --panel2:#0f1623;
      --text:#e8eefc;
      --muted:rgba(232,238,252,.65);
      --good:#2ee59d;
      --bad:#ff4d6d;
      --warn:#ffcc66;
      --line:rgba(255,255,255,.10);
      --accent:#7aa8ff;
      --cursed:#ff2e55;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:var(--bg);
      overflow-x:hidden;
    }
    #bgImage{
      position:fixed; inset:0;
      background-size:cover;
      background-position:center;
      filter:saturate(1.05) contrast(1.05) brightness(.55);
      transform:scale(1.03);
      z-index:-2;
    }
    #bgShade{
      position:fixed; inset:0;
      background:radial-gradient(1000px 600px at 30% 10%, rgba(122,168,255,.25), transparent 60%),
                 linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.75));
      z-index:-1;
    }
    .app{
      max-width:1120px;
      margin:0 auto;
      padding:18px 14px 80px;
    }
    header{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(18,26,40,.72);
      backdrop-filter: blur(10px);
      border-radius:14px;
    }
    .title{
      display:flex; flex-direction:column; line-height:1.1;
    }
    .title b{font-size:18px; letter-spacing:.2px}
    .title span{font-size:12px; color:var(--muted)}
    .pillRow{display:flex; gap:10px; align-items:center}
    .pill{
      font-size:12px;
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(15,22,35,.85);
      color:var(--muted);
      white-space:nowrap;
    }
    .pill strong{color:var(--text)}
    .btn{
      border:1px solid var(--line);
      background:rgba(15,22,35,.85);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight:700;
      transition:transform .08s ease, filter .08s ease, opacity .15s ease;
    }
    .btn:active{transform:scale(.985)}
    .btn.primary{background:linear-gradient(135deg, rgba(122,168,255,.25), rgba(122,168,255,.06)); border-color:rgba(122,168,255,.35)}
    .btn.good{background:linear-gradient(135deg, rgba(46,229,157,.18), rgba(46,229,157,.06)); border-color:rgba(46,229,157,.35)}
    .btn.bad{background:linear-gradient(135deg, rgba(255,77,109,.20), rgba(255,77,109,.06)); border-color:rgba(255,77,109,.35)}
    .btn.ghost{background:transparent}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .9fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      border:1px solid var(--line);
      background:rgba(18,26,40,.72);
      backdrop-filter: blur(10px);
      border-radius:16px;
      padding:12px;
    }
    .card h2{
      margin:0 0 8px;
      font-size:15px;
      letter-spacing:.2px;
      color:rgba(232,238,252,.92);
    }
    .muted{color:var(--muted)}
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:12px;
    }
    .tab{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(15,22,35,.65);
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      color:rgba(232,238,252,.72);
    }
    .tab.active{
      color:var(--text);
      border-color:rgba(122,168,255,.45);
      background:rgba(122,168,255,.14);
    }
    .hidden{display:none !important;}
  </style>
</head>
<!-- âœ… PART 2 / 6 â€” CSS (portraits, stats lines, modals, animations) -->
<body>
  <div id="bgImage"></div>
  <div id="bgShade"></div>

  <div class="app">
    <header>
      <div class="title">
        <b>Wheel Forge</b>
        <span class="muted">Build â€¢ Stats â€¢ PvE â€¢ PvP</span>
      </div>
      <div class="pillRow">
        <div id="dailyPill" class="pill">Daily Build: <strong>â€¦</strong></div>
        <button id="volBtn" class="btn">ðŸ”Š</button>
        <button id="resetBtn" class="btn ghost">Reset</button>
      </div>
    </header>

    <div class="tabs">
      <div class="tab active" data-tab="build">BUILD</div>
      <div class="tab" data-tab="stats">STATS</div>
      <div class="tab" data-tab="pve">PvE</div>
      <div class="tab" data-tab="pvp">PvP</div>
      <div id="phaseTag" class="pill">Phase: â€¦</div>
      <div id="namedTag" class="pill">Not finalized</div>
    </div>

    <style>
      /* Portrait frames */
      .portraitWrap{display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap}
      .frame{
        position:relative;
        width:260px;
        height:260px;
        border-radius:18px;
        border:1px solid var(--line);
        background:rgba(15,22,35,.65);
        overflow:hidden;
      }
      .frame.bigRig{width:300px;height:300px}
      .frame.cursed{box-shadow:0 0 0 2px rgba(255,46,85,.22), 0 0 36px rgba(255,46,85,.25) inset}
      .layer{
        position:absolute;
        inset:0;
        width:100%;
        height:100%;
        object-fit:contain;
        pointer-events:none;
      }
      .fx{mix-blend-mode:screen; opacity:.92}
      .fx.on{opacity:1}
      .idle-sway{animation:sway 3.0s ease-in-out infinite}
      .idle-heavy{animation:swayHeavy 3.6s ease-in-out infinite}
      @keyframes sway{0%,100%{transform:translateY(0)}50%{transform:translateY(4px)}}
      @keyframes swayHeavy{0%,100%{transform:translateY(0)}50%{transform:translateY(6px)}}

      .portraitUnlockPulse{animation:pulse .65s ease-out 1}
      @keyframes pulse{
        0%{transform:scale(1); box-shadow:0 0 0 0 rgba(46,229,157,.0)}
        35%{transform:scale(1.02); box-shadow:0 0 0 10px rgba(46,229,157,.12)}
        100%{transform:scale(1); box-shadow:0 0 0 0 rgba(46,229,157,.0)}
      }

      /* Wheel area */
      #wheelBox{display:flex; flex-direction:column; gap:10px}
      #wheelTitle{font-size:16px; font-weight:900}
      #wheelHint{font-size:12px; color:var(--muted)}
      canvas{width:100%; max-width:520px; height:auto; border-radius:16px; border:1px solid var(--line); background:rgba(0,0,0,.15)}
      .btnRow{display:flex; gap:10px; flex-wrap:wrap}

      /* Stats lines */
      .statList{display:grid; gap:8px}
      .statLine{
        display:flex; justify-content:space-between; gap:10px;
        padding:10px 10px;
        border-radius:12px;
        border:1px solid var(--line);
        background:rgba(15,22,35,.55);
      }
      .statKey{color:rgba(232,238,252,.70); font-weight:800}
      .statVal{color:rgba(232,238,252,.95); font-weight:900; text-align:right}

      /* Badges */
      .badgeRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
      .badge{
        display:inline-flex; gap:8px; align-items:center;
        padding:6px 10px;
        border-radius:999px;
        border:1px solid var(--line);
        background:rgba(15,22,35,.65);
        font-size:12px;
        font-weight:900;
      }
      .badge.cursed{border-color:rgba(255,46,85,.45); background:rgba(255,46,85,.12)}
      .badge .icon{font-size:14px}

      /* Trait slots */
      .slotsGrid{display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); gap:10px}
      @media (max-width:520px){.slotsGrid{grid-template-columns:1fr}}
      .slotCard{
        border:1px solid var(--line);
        background:rgba(15,22,35,.55);
        border-radius:14px;
        padding:10px;
        position:relative;
        cursor:pointer;
      }
      .slotLocked{opacity:.80}
      .closestSlot{outline:2px solid rgba(122,168,255,.30)}
      .slotTop{display:flex; justify-content:space-between; align-items:center}
      .slotName{font-weight:1000}
      .slotDesc{margin-top:6px; color:rgba(232,238,252,.72); font-size:12px}
      .slotProgressWrap{
        margin-top:10px;
        height:8px;
        background:rgba(255,255,255,.08);
        border-radius:999px;
        overflow:hidden;
      }
      .slotProgressBar{
        height:100%;
        background:linear-gradient(90deg, rgba(122,168,255,.65), rgba(122,168,255,.20));
        width:0%;
      }
      .slotProgressText{margin-top:6px; font-size:12px; color:rgba(232,238,252,.65)}
      .barPulse{animation:barPulse .65s ease-out 1}
      @keyframes barPulse{0%{filter:brightness(1)}45%{filter:brightness(1.6)}100%{filter:brightness(1)}}
      .plusOne{
        position:absolute;
        right:10px;
        bottom:10px;
        font-weight:1000;
        color:var(--good);
        animation:floatUp .65s ease-out 1;
      }
      @keyframes floatUp{0%{transform:translateY(0); opacity:1}100%{transform:translateY(-14px); opacity:0}}

      /* Toast */
      #toast{
        position:fixed;
        left:50%;
        bottom:18px;
        transform:translateX(-50%);
        background:rgba(10,15,25,.92);
        border:1px solid var(--line);
        padding:10px 12px;
        border-radius:999px;
        opacity:0;
        pointer-events:none;
        transition:opacity .18s ease;
        font-weight:900;
        z-index:50;
      }
      #toast.show{opacity:1}

      /* Modals */
      .modal{
        position:fixed; inset:0;
        display:flex; align-items:center; justify-content:center;
        background:rgba(0,0,0,.55);
        z-index:60;
        padding:18px;
      }
      .modal.hidden{display:none}
      .modalCard{
        width:min(520px, 100%);
        border-radius:16px;
        border:1px solid var(--line);
        background:rgba(18,26,40,.95);
        padding:14px;
      }
      .modalTop{display:flex; justify-content:space-between; align-items:center; gap:12px}
      .modalTitle{font-weight:1000; font-size:16px}
      .modalSub{color:rgba(232,238,252,.70); font-size:12px; margin-top:6px}
      .modalBtns{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
      input{
        width:100%;
        padding:12px 12px;
        border-radius:14px;
        border:1px solid var(--line);
        background:rgba(15,22,35,.65);
        color:var(--text);
        font-weight:900;
        outline:none;
      }

      /* Loot */
      .lootRow{
        display:flex; justify-content:space-between; gap:12px;
        padding:10px;
        border:1px solid var(--line);
        background:rgba(15,22,35,.55);
        border-radius:12px;
        margin-top:10px;
      }
      .lootLabel{font-weight:1000}
      .lootNote{font-size:12px; color:rgba(232,238,252,.65)}
      .lootValue{font-weight:1000}

      /* Confetti */
      .confetti{position:fixed; inset:0; pointer-events:none; z-index:80;}
      .confettiPiece{
        width:10px;height:10px;border-radius:3px;
        position:absolute; left:50%; top:40%;
        transform:translate(-50%,-50%);
        animation:conf .8s ease-out forwards;
      }
      @keyframes conf{
        to{ transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) rotate(var(--rot)); opacity:0;}
      }

      /* PvP steal animation */
      #stealAnim{position:fixed; inset:0; pointer-events:none; z-index:90;}
      #stealAnim.hidden{display:none}
      #stealChip{
        position:fixed;
        padding:10px 12px;
        border-radius:999px;
        border:1px solid rgba(255,255,255,.18);
        background:rgba(10,15,25,.92);
        font-weight:1000;
        opacity:0;
        transform:translate(-50%,-50%);
      }
      #stealChip.flyNow{
        opacity:1;
        animation:fly .65s ease-out forwards;
      }
      @keyframes fly{
        to{ left:var(--dx); top:var(--dy); opacity:0; transform:translate(-50%,-50%) scale(.9); }
      }
      #stealPopup{
        position:fixed;
        top:12px;
        left:50%;
        transform:translateX(-50%);
        z-index:95;
        padding:10px 12px;
        border-radius:999px;
        border:1px solid rgba(255,255,255,.18);
        background:rgba(10,15,25,.92);
        font-weight:1000;
      }
      #stealPopup.hidden{display:none}
    </style>
    <!-- âœ… PART 3 / 6 â€” BUILD tab + wheel + build portrait + trait slots + build log -->
    <section id="tab-build" class="grid">
      <div class="card" id="wheelBox">
        <div>
          <div id="wheelTitle">Race</div>
          <div id="wheelHint">Spin the wheel</div>
        </div>

        <canvas id="wheel" width="520" height="520"></canvas>

        <div class="btnRow">
          <button id="spinBtn" class="btn primary">Spin</button>
          <button id="finalizeBtn" class="btn good">Finalize</button>
          <button id="newBuildBtn" class="btn">New Build</button>
          <button id="skipBtn" class="btn ghost">Skip (test)</button>
          <button id="testFastBtn" class="btn ghost">Fast Spin (test)</button>
        </div>

        <div class="muted" id="buildHint">Spin for Race.</div>

        <div class="card" style="padding:12px; background:rgba(15,22,35,.45); border-color:rgba(255,255,255,.08)">
          <h2>Build Log</h2>
          <div id="buildLog" class="muted"></div>
        </div>
      </div>

      <div class="card">
        <h2>Character</h2>
        <div class="portraitWrap">
          <div id="charFrame" class="frame idle-sway">
            <img id="layer_base" class="layer" alt="">
            <img id="layer_body" class="layer" alt="">
            <img id="layer_back" class="layer" alt="">
            <img id="layer_legs" class="layer" alt="">
            <img id="layer_arms" class="layer" alt="">
            <img id="layer_head" class="layer" alt="">
            <img id="layer_armor" class="layer" alt="">
            <img id="layer_weapon" class="layer" alt="">
            <img id="layer_fx" class="layer fx" alt="">
          </div>

          <div style="flex:1; min-width:260px">
            <h2>Build Stats</h2>
            <div id="buildStats" class="statList"></div>
            <div id="buildBadges" class="badgeRow"></div>

            <h2 style="margin-top:12px">Trait Slots</h2>
            <div id="traitSlots" class="slotsGrid"></div>
          </div>
        </div>
      </div>
    </section>
<script>
/* =========================================================
   PART 4 â€” CORE ENGINE / WHEEL / PHASES / NAME
========================================================= */

/* ---------- helpers ---------- */
const $ = (id)=>document.getElementById(id);
const escapeHtml = (s)=>String(s??"").replace(/[&<>"']/g,m=>({
  "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
}[m]));

/* ---------- constants ---------- */
const PHASES = ["Race","Power","Weapon","Armor","Trainer","Transformation"];
let currentPhaseIndex = 0;

/* ---------- options ---------- */
const RACE_OPTIONS = ["Human","Saiyan","Demon","Angel","God","Dragon"];
const POWER_OPTIONS = ["Fire","Ice","Lightning","Adaptation","Regeneration","No Power"];
const WEAPON_OPTIONS = ["Sword","Axe","Hammer","No Weapon"];
const ARMOR_OPTIONS = ["Berserk Armor","Iron Man Suit","No Armor"];
const TRAINER_OPTIONS = ["Master Roshi","Jiraiya","Yuujirou","No Trainer"];
const TRANSFORM_OPTIONS = ["None","Kaioken","Super Saiyan"];

/* ---------- state ---------- */
function defaultState(){
  return {
    character:{
      finalized:false,
      name:"",
      race:null,
      powers:[],
      weapons:[],
      armors:[],
      trainer:null,
      transformation:"None",
      strengthW:"Human",
      speedW:"Human",
      durabilityW:"Human",
      fightW:"Street",
      iqW:"Average",
      luckW:"5"
    },
    progress:{ adaptationStacks:0, soulBonus:{} },
    currency:{ coins:0, xp:0 }
  };
}

let state = JSON.parse(localStorage.getItem("wheelForgeState")||"null") || defaultState();
function saveState(){ localStorage.setItem("wheelForgeState", JSON.stringify(state)); }

/* ---------- toast ---------- */
function toast(msg){
  const t = $("toast");
  if(!t) return;
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1200);
}

/* ---------- wheel ---------- */
const canvas = $("wheel");
const ctx = canvas.getContext("2d");
let spinning = false;

function drawWheel(options){
  const r = canvas.width/2;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const slice = (Math.PI*2)/options.length;

  options.forEach((opt,i)=>{
    ctx.beginPath();
    ctx.moveTo(r,r);
    ctx.arc(r,r,r,i*slice,(i+1)*slice);
    ctx.fillStyle = i%2 ? "#1b2a44" : "#243a66";
    ctx.fill();
    ctx.save();
    ctx.translate(r,r);
    ctx.rotate(i*slice+slice/2);
    ctx.fillStyle="#fff";
    ctx.font="bold 14px system-ui";
    ctx.fillText(opt, r*0.55, 4);
    ctx.restore();
  });
}

function currentOptions(){
  switch(PHASES[currentPhaseIndex]){
    case "Race": return RACE_OPTIONS;
    case "Power": return POWER_OPTIONS;
    case "Weapon": return WEAPON_OPTIONS;
    case "Armor": return ARMOR_OPTIONS;
    case "Trainer": return TRAINER_OPTIONS;
    case "Transformation": return TRANSFORM_OPTIONS;
  }
}

function applyResult(result){
  const c = state.character;
  switch(PHASES[currentPhaseIndex]){
    case "Race": c.race=result; break;
    case "Power": if(result!=="No Power") c.powers.push(result); break;
    case "Weapon": if(result!=="No Weapon") c.weapons.push(result); break;
    case "Armor": if(result!=="No Armor") c.armors.push(result); break;
    case "Trainer": if(result!=="No Trainer") c.trainer=result; break;
    case "Transformation": c.transformation=result; break;
  }
}

function spinWheel(){
  if(spinning || state.character.finalized) return;
  spinning=true;
  const opts = currentOptions();
  drawWheel(opts);
  setTimeout(()=>{
    const pick = opts[Math.floor(Math.random()*opts.length)];
    applyResult(pick);
    $("buildLog").innerHTML =
      `<div>${PHASES[currentPhaseIndex]}: <b>${escapeHtml(pick)}</b></div>` +
      $("buildLog").innerHTML;
    currentPhaseIndex++;
    spinning=false;
    refreshUI();
    if(currentPhaseIndex >= PHASES.length){
      toast("All phases complete. Finalize!");
    }
  },900);
}

/* ---------- finalize + name ---------- */
function finalizeBuild(){
  if(currentPhaseIndex < PHASES.length){
    toast("Finish all spins first");
    return;
  }
  state.character.finalized = true;
  openNameModal();
  refreshUI();
}

function openNameModal(){
  $("nameModal").classList.remove("hidden");
  $("nameInput").value = "";
}

function confirmName(){
  const v = $("nameInput").value.trim();
  if(!v) return;
  state.character.name = v;
  $("nameModal").classList.add("hidden");
  saveState();
  refreshUI();
}

/* ---------- UI ---------- */
function refreshUI(){
  $("wheelTitle").textContent = PHASES[currentPhaseIndex] || "Complete";
  $("namedTag").textContent = state.character.finalized ? "Finalized" : "Not finalized";
  drawWheel(currentOptions());
  saveState();
}

/* ---------- buttons ---------- */
$("spinBtn").addEventListener("click", spinWheel);
$("finalizeBtn").addEventListener("click", finalizeBuild);

/* ---------- init ---------- */
refreshUI();
</script>
<script>
/* =========================================================
   PART 5 â€” ADDITIVE STAT SYSTEM
========================================================= */

const STAT_WORDS = {
  strength:["Weak","Human","Enhanced","Superhuman","City","Mountain","Planetary","Universal","???"],
  speed:["Slow","Human","Supersonic","Lightning","Light","FTL","Infinite","???"],
  durability:["Fragile","Human","Steel","City","Mountain","Planetary","Universal","???"],
  fight:["Untrained","Street","Elite","Master","Legendary","???"],
  iq:["Dull","Average","Genius","Supergenius","Omniscient","???"]
};

function statWordToNumber(k,w){
  const i = (STAT_WORDS[k]||[]).indexOf(w);
  return i<0?0:i*10;
}
function labelForStat(k,v){
  const t=Math.floor(v/10);
  return (STAT_WORDS[k]||[])[Math.min(t,(STAT_WORDS[k]||[]).length-1)]||"???";
}

function computeFinalStats(c){
  const base={
    strength:statWordToNumber("strength",c.strengthW),
    speed:statWordToNumber("speed",c.speedW),
    durability:statWordToNumber("durability",c.durabilityW),
    fight:statWordToNumber("fight",c.fightW),
    iq:statWordToNumber("iq",c.iqW)
  };
  Object.keys(state.progress.soulBonus).forEach(k=>{
    base[k]+=state.progress.soulBonus[k];
  });
  base.luck=parseInt(c.luckW)||5;
  base.labels={
    strength:labelForStat("strength",base.strength),
    speed:labelForStat("speed",base.speed),
    durability:labelForStat("durability",base.durability),
    fight:labelForStat("fight",base.fight),
    iq:labelForStat("iq",base.iq)
  };
  return base;
}
</script>
<script>
/* =========================================================
   PART 6 â€” PvE / PvP
========================================================= */

const FLEE_HP_THRESHOLD = 0.3;

function fleeChanceFromSpeedGap(p,e){
  const d=Math.abs(p-e);
  if(d>40) return 0;
  return Math.max(0.05,1-d/40);
}
function roll(c){return Math.random()<c;}

function computeHP(s){ return 60 + s.durability*8 + s.fight*2; }
function computeDamage(a,d){
  return Math.max(5,Math.round((a.strength*2+a.fight*3)-(d.durability*1.5)));
}

async function startPVP(){
  if(!state.character.finalized){toast("Finalize first");return;}
  const p=computeFinalStats(state.character);
  const e={...p,strength:p.strength-10};
  let php=computeHP(p),ehp=computeHP(e);
  while(php>0&&ehp>0){
    if(php/computeHP(p)<FLEE_HP_THRESHOLD && roll(fleeChanceFromSpeedGap(p.speed,e.speed))){
      toast("You fled!");
      return;
    }
    ehp-=computeDamage(p,e);
    if(ehp<=0) break;
    php-=computeDamage(e,p);
    await new Promise(r=>setTimeout(r,80));
  }
  toast(php>0?"PvP Victory!":"Defeat");
}

async function startPVE(){
  if(!state.character.finalized){toast("Finalize first");return;}
  toast("PvE victory!");
}

/* ---------- buttons ---------- */
$("pvpStartBtn")?.addEventListener("click", startPVP);
$("pveStartBtn")?.addEventListener("click", startPVE);
</script>
